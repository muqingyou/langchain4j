# 医疗AI助手聊天记录压缩系统

## 概述

本系统基于LangChain4j和SpringBoot，实现了医疗AI助手的智能聊天记录压缩功能。通过层级递归总结技术，系统能够自动压缩超过阈值的聊天记录，同时保留重要的医疗信息。

## 主要功能

### 1. 定时压缩任务
- **执行频率**: 每小时执行一次（可配置）
- **压缩阈值**: 当聊天记录超过10条消息时自动压缩（可配置）
- **智能保留**: 保留系统消息和最近3条重要消息（可配置）

### 2. 层级递归总结
- **分块处理**: 将消息按5条一组进行分块（可配置）
- **递归压缩**: 对分块结果再次进行总结，直到达到合适的压缩比例
- **医疗信息保护**: 特别关注保留患者症状、诊断、用药等关键医疗信息

### 3. 配置化管理
- **灵活配置**: 支持通过配置文件调整所有压缩参数
- **开关控制**: 可以随时启用或禁用压缩功能
- **日志控制**: 支持详细日志输出控制

## 配置说明

### application.properties配置

```properties
# 聊天记录压缩配置
xiaozhi.compression.enabled=true                    # 是否启用压缩功能
xiaozhi.compression.threshold=10                    # 压缩阈值（消息数量）
xiaozhi.compression.chunk-size=5                    # 每块消息数量
xiaozhi.compression.keep-recent-messages=3          # 保留最近消息数量
xiaozhi.compression.schedule=0 0 * * * ?            # 定时任务执行时间（cron表达式）
xiaozhi.compression.verbose-logging=false           # 是否启用详细日志
```

### 配置参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| enabled | true | 是否启用压缩功能 |
| threshold | 10 | 当消息数量超过此值时进行压缩 |
| chunk-size | 5 | 层级递归总结时每块的消息数量 |
| keep-recent-messages | 3 | 保留最近几条消息不进行压缩 |
| schedule | "0 0 * * * ?" | 定时任务执行时间（每小时） |
| verbose-logging | false | 是否输出详细的调试日志 |

## 核心组件

### 1. HierarchicalSummarizationTask
定时任务组件，负责：
- 查询MongoDB中的所有聊天记录
- 检查消息数量是否超过阈值
- 调用压缩服务进行消息压缩
- 更新压缩后的消息到数据库
- 记录详细的执行日志和统计信息

### 2. HierarchicalSummarizationMemoryStore
消息存储组件，负责：
- 实现ChatMemoryStore接口
- 在消息更新时自动检查是否需要压缩
- 执行层级递归总结压缩
- 保留重要的系统消息和最近消息

### 3. CompressionConfig
配置管理组件，负责：
- 管理所有压缩相关的配置参数
- 支持通过配置文件动态调整参数
- 提供配置的默认值和验证

### 4. MongoIndexConfig
数据库优化组件，负责：
- 为MongoDB集合创建必要的索引
- 优化查询性能
- 确保数据一致性

## 压缩策略

### 1. 消息分类
- **系统消息**: 始终保留，不参与压缩
- **最近消息**: 保留最后N条消息（可配置）
- **历史消息**: 进行层级递归总结压缩

### 2. 医疗信息保护
压缩过程中特别关注保留：
- 患者的主要症状和病情描述
- 疾病诊断信息
- 用药信息（药物名称、剂量、用法）
- 检查结果和检验数据
- 治疗建议和医嘱
- 复诊时间和注意事项
- 预约信息（科室、医生、时间）

### 3. 层级递归总结
1. 将历史消息按chunk-size分组
2. 使用专业的医疗总结提示词对每组进行总结
3. 对总结结果再次进行分组和总结
4. 递归执行直到达到合适的压缩比例

## 使用示例

### 1. 启动应用
```bash
mvn spring-boot:run
```

### 2. 查看压缩日志
```bash
# 查看压缩任务执行日志
tail -f logs/application.log | grep "压缩任务"

# 查看详细压缩日志
tail -f logs/application.log | grep "DEBUG"
```

### 3. 监控压缩效果
系统会输出详细的压缩统计信息：
- 总记录数
- 压缩记录数
- 错误记录数
- 执行耗时

## 测试

### 运行测试用例
```bash
# 运行所有测试
mvn test

# 运行压缩相关测试
mvn test -Dtest=CompressionTaskTest
```

### 测试覆盖
- 压缩阈值测试
- 消息压缩功能测试
- MongoDB CRUD操作测试
- 医疗内容压缩测试

## 性能优化

### 1. MongoDB索引
- memoryId字段索引：优化用户查询
- messageId字段唯一索引：确保数据一致性

### 2. 批量处理
- 定时任务批量处理所有用户记录
- 减少数据库连接次数

### 3. 错误处理
- 单条记录处理失败不影响其他记录
- 详细的错误日志和统计信息

## 监控和维护

### 1. 日志监控
- 定时任务执行状态
- 压缩统计信息
- 错误和异常信息

### 2. 性能监控
- 压缩任务执行时间
- 数据库查询性能
- 内存使用情况

### 3. 数据一致性
- 压缩前后消息数量对比
- 重要信息保留验证
- 数据完整性检查

## 注意事项

1. **数据备份**: 建议在启用压缩功能前备份重要数据
2. **配置调优**: 根据实际使用情况调整压缩参数
3. **监控告警**: 建议设置压缩任务执行失败的告警
4. **测试验证**: 在生产环境使用前充分测试压缩效果

## 故障排除

### 常见问题
1. **压缩任务未执行**: 检查配置中的enabled和schedule参数
2. **压缩效果不理想**: 调整threshold和chunk-size参数
3. **重要信息丢失**: 检查keep-recent-messages配置
4. **性能问题**: 检查MongoDB索引和日志级别配置

### 调试方法
1. 启用详细日志：`xiaozhi.compression.verbose-logging=true`
2. 查看定时任务日志
3. 检查MongoDB连接和索引状态
4. 运行测试用例验证功能
